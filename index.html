<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Astro File Explorer</title>
<style>
  :root{
    --bg:#0b0f14; --panel:#0f1720; --muted:#9aa6b2; --accent:#66d9ef;
    --card:#0c1116; --glass: rgba(255,255,255,0.03);
  }
  html,body{height:100%; margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Arial; background:var(--bg); color:#e6eef6;}
  .app{display:flex; height:100vh; gap:12px; padding:12px; box-sizing:border-box;}
  /* Sidebar */
  .sidebar{width:260px; background:linear-gradient(180deg,#07101a 0%, #0b141a 100%); border-radius:10px; padding:10px; box-shadow: 0 6px 18px rgba(0,0,0,0.6); display:flex; flex-direction:column;}
  .brand{font-weight:700; color:var(--accent); margin:6px 8px; font-size:14px;}
  .search{margin:8px; display:flex;}
  .search input{flex:1; background:transparent; border:1px solid rgba(255,255,255,0.04); color:var(--muted); padding:8px; border-radius:6px; outline:none;}
  .folders{overflow:auto; padding:6px; margin-top:6px;}
  .folder{display:flex; align-items:center; gap:8px; padding:8px; border-radius:6px; cursor:pointer; user-select:none;}
  .folder:hover{background:var(--glass);}
  .folder.active{background:linear-gradient(90deg, rgba(102,217,239,0.08), rgba(102,217,239,0.02)); outline:1px solid rgba(102,217,239,0.06);}
  .icondir{width:28px;height:28px;background:linear-gradient(180deg,#123 0%,#145 100%); border-radius:6px; display:flex; align-items:center; justify-content:center; font-weight:700; color:#cfeff6;}
  /* Main */
  .main{flex:1; display:flex; gap:12px;}
  .files-panel{flex:1; background:var(--panel); border-radius:10px; padding:12px; overflow:auto;}
  .files-header{display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;}
  .breadcrumbs{color:var(--muted); font-size:13px;}
  .grid{display:grid; grid-template-columns: repeat(auto-fill,minmax(180px,1fr)); gap:12px;}
  .file-card{background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent); padding:8px; border-radius:8px; display:flex; flex-direction:column; gap:8px; cursor:pointer; transition:transform .08s;}
  .file-card:hover{transform:translateY(-4px);}
  .thumb{height:120px; border-radius:6px; background:#000; display:flex; align-items:center; justify-content:center; overflow:hidden; position:relative;}
  .thumb img{width:100%; height:100%; object-fit:cover;}
  .meta{font-size:13px; color:var(--muted); display:flex; justify-content:space-between; align-items:center;}
  .name{font-weight:600; color:#dfefff; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}
  /* Preview */
  .preview{width:480px; max-width:45%; background:linear-gradient(180deg,#071017,#071018); border-radius:10px; padding:12px; display:flex; flex-direction:column; gap:10px; box-shadow:0 8px 30px rgba(0,0,0,0.6);}
  .viewer{flex:1; background:#000; border-radius:8px; display:flex; align-items:center; justify-content:center; overflow:hidden; position:relative;}
  .viewer img{max-width:100%; max-height:100%; transform-origin:center center; transition:transform .12s linear;}
  .controls{display:flex; gap:8px; align-items:center; justify-content:flex-end;}
  .btn{background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.02); padding:8px 10px; border-radius:6px; color:var(--muted); cursor:pointer; font-size:13px;}
  .muted{color:var(--muted); font-size:13px;}
  .small{font-size:12px; color:var(--muted);}
  /* Responsive */
  @media (max-width:1000px){
    .preview{display:none;}
    .sidebar{width:210px;}
  }
</style>
</head>
<body>
<div class="app" id="app">
  <aside class="sidebar">
    <div class="brand">Astro Explorer</div>
    <div class="search"><input id="folderFilter" placeholder="Filter folders (type 'M', 'NGC', etc.)" /></div>
    <div class="folders" id="folders" aria-live="polite"></div>
    <div style="padding:8px;color:var(--muted);font-size:12px;">Auto-detects GitHub repo from URL. Uses GitHub API (public).</div>
  </aside>

  <main class="main">
    <section class="files-panel">
      <div class="files-header">
        <div class="breadcrumbs" id="breadcrumbs">/</div>
        <div class="muted" id="status">loading...</div>
      </div>
      <div class="grid" id="grid"></div>
    </section>

    <aside class="preview" id="previewPanel" aria-hidden="true">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div>
          <div id="previewTitle" style="font-weight:700;color:#dff8ff;"></div>
          <div class="small" id="previewDate"></div>
        </div>
        <div class="controls">
          <button class="btn" id="fitBtn">Fit</button>
          <button class="btn" id="zoomIn">Zoom +</button>
          <button class="btn" id="zoomOut">Zoom −</button>
          <button class="btn" id="prevBtn">←</button>
          <button class="btn" id="nextBtn">→</button>
          <button class="btn" id="openRaw">Open raw</button>
        </div>
      </div>
      <div class="viewer" id="viewer"><div class="muted">Select an image to preview</div></div>
      <div class="small" id="footerNote">Navigate folders on the left • images load lazily</div>
    </aside>
  </main>
</div>

<script>
(async function(){
  // Utility: parse owner/repo from GitHub Pages page URL
  function detectOwnerRepo(){
    const host = location.hostname; // e.g. nmbrs1.github.io
    const path = location.pathname.replace(/^\/|\/$/g,'').split('/');
    let owner = null, repo = null;
    if(host.endsWith('github.io')){
      owner = host.split('.')[0];
      if(path.length && path[0] !== ''){
        repo = path[0];
      } else {
        // user pages repo == owner.github.io
        repo = owner + '.github.io';
      }
    } else {
      // fallback: if user is previewing locally, ask user in console:
      owner = prompt('Enter your GitHub username (owner):') || '';
      repo  = prompt('Enter your repository name (repo):') || '';
    }
    return {owner, repo};
  }

  const {owner, repo} = detectOwnerRepo();
  if(!owner || !repo){
    document.getElementById('status').textContent = 'Repo detection failed. Open this page from GitHub Pages or run locally and provide owner/repo.';
    return;
  }

  const apiBase = `https://api.github.com/repos/${owner}/${repo}/contents`;
  const rawBase = `https://raw.githubusercontent.com/${owner}/${repo}/main`; // assume main branch for raw files

  const state = {folders:[], currentFolder:null, files:[], currentIndex:-1, zoom:1};

  const foldersEl = document.getElementById('folders');
  const gridEl = document.getElementById('grid');
  const statusEl = document.getElementById('status');
  const breadcrumbsEl = document.getElementById('breadcrumbs');
  const viewerEl = document.getElementById('viewer');
  const previewPanel = document.getElementById('previewPanel');
  const previewTitle = document.getElementById('previewTitle');
  const previewDate = document.getElementById('previewDate');

  document.getElementById('folderFilter').addEventListener('input', e=>{
    renderFolders(e.target.value.trim());
  });

  // Controls
  document.getElementById('zoomIn').addEventListener('click', ()=>setZoom(state.zoom * 1.25));
  document.getElementById('zoomOut').addEventListener('click', ()=>setZoom(state.zoom / 1.25));
  document.getElementById('fitBtn').addEventListener('click', ()=>setZoom(1));
  document.getElementById('prevBtn').addEventListener('click', ()=>navigate(-1));
  document.getElementById('nextBtn').addEventListener('click', ()=>navigate(1));
  document.getElementById('openRaw').addEventListener('click', ()=>{
    if(state.currentIndex >= 0) window.open(state.files[state.currentIndex].raw, '_blank');
  });

  window.addEventListener('keydown', (e)=>{
    if(e.key === 'ArrowLeft') navigate(-1);
    if(e.key === 'ArrowRight') navigate(1);
    if(e.key === 'Escape'){ /* future: close */ }
  });

  function setStatus(s){ statusEl.textContent = s; }

  // Fetch and show root contents
  async function fetchContents(path=''){
    setStatus('fetching contents...');
    const url = apiBase + (path ? '/' + encodeURIComponent(path) : '');
    const res = await fetch(url);
    if(res.status === 404){
      setStatus('Repo path not found: ' + path);
      return [];
    }
    if(res.status === 403){
      setStatus('API rate limited or access denied. Try adding a personal token or wait a bit.');
      return [];
    }
    const data = await res.json();
    return data;
  }

  function sortFolders(list){
    return list.sort((a,b)=>{
      const A = a.name.toUpperCase(), B = b.name.toUpperCase();
      if(A < B) return -1; if(A > B) return 1; return 0;
    });
  }

  async function loadRoot(){
    const data = await fetchContents('');
    if(!Array.isArray(data)){
      setStatus('Unexpected GitHub API response');
      return;
    }
    // Filter directories only
    const dirs = data.filter(x => x.type === 'dir').map(x => ({name: x.name, path: x.path}));
    state.folders = sortFolders(dirs);
    renderFolders();
    setStatus(`Found ${state.folders.length} folders`);
    // Optionally auto-open first folder
    if(state.folders.length) {
      // do not auto-open to let user choose — but you can uncomment next line:
      // openFolder(state.folders[0].path);
    }
  }

  function renderFolders(filter=''){
    foldersEl.innerHTML = '';
    const list = state.folders.filter(f => !filter || f.name.toLowerCase().includes(filter.toLowerCase()));
    if(list.length===0){
      foldersEl.innerHTML = `<div style="padding:12px;color:var(--muted)">No folders match.</div>`;
      return;
    }
    for(const f of list){
      const el = document.createElement('div');
      el.className = 'folder';
      if(state.currentFolder && state.currentFolder === f.path) el.classList.add('active');
      el.innerHTML = `<div class="icondir">${escapeHtml(f.name.slice(0,2))}</div><div style="flex:1"><div style="font-weight:600;color:#dfefff">${escapeHtml(f.name)}</div><div class="small" style="margin-top:2px;color:var(--muted)">${escapeHtml(f.path)}</div></div>`;
      el.onclick = ()=>openFolder(f.path, f.name);
      foldersEl.appendChild(el);
    }
  }

  async function openFolder(path, name){
imgs.sort((a,b)=> {
  // If both have dates, sort by date desc
  if(a.date && b.date) return b.date.localeCompare(a.date);
  // If only one has a date, that one comes first
  if(a.date && !b.date) return -1;
  if(!a.date && b.date) return 1;
  // Otherwise, sort alphabetically
  return a.name.localeCompare(b.name);
});

    }
    // Filter jpg/jpeg files
    const imgs = data.filter(x => x.type === 'file' && /\.(jpe?g|png)$/i.test(x.name))
                     .map(x => ({
                       name: x.name,
                       path: x.path,
                       raw: `https://raw.githubusercontent.com/${owner}/${repo}/main/${x.path}`,
                       size: x.size,
                       date: extractDateFromName(x.name)
                     }));
    imgs.sort((a,b)=> (b.date || '').localeCompare(a.date || '') || a.name.localeCompare(b.name));
    state.files = imgs;
    state.currentIndex = imgs.length ? 0 : -1;
    renderFiles();
    setStatus(`${imgs.length} image(s)`);
    if(imgs.length) previewImage(0); else clearPreview();
  }

  function renderFiles(){
    gridEl.innerHTML = '';
    if(state.files.length === 0){
      gridEl.innerHTML = `<div style="padding:16px;color:var(--muted)">No JPG/PNG files found in this folder.</div>`;
      return;
    }
    for(let i=0;i<state.files.length;i++){
      const f = state.files[i];
      const card = document.createElement('div');
      card.className = 'file-card';
      card.onclick = ()=> previewImage(i);
      card.innerHTML = `
        <div class="thumb"><img loading="lazy" alt="${escapeHtml(f.name)}" src="${f.raw}"></div>
        <div style="display:flex;flex-direction:column;gap:4px">
          <div class="name">${escapeHtml(f.name)}</div>
          <div class="meta"><div class="small">${f.date || 'unknown date'}</div><div class="small">${(f.size/1024|0)} KB</div></div>
        </div>
      `;
      gridEl.appendChild(card);
    }
  }

  function clearPreview(){
    previewPanel.setAttribute('aria-hidden','true');
    viewerEl.innerHTML = '<div class="muted">Select an image to preview</div>';
    previewTitle.textContent = '';
    previewDate.textContent = '';
  }

  function setZoom(z){
    state.zoom = Math.max(0.25, Math.min(8, z));
    const img = viewerEl.querySelector('img');
    if(img) img.style.transform = `scale(${state.zoom})`;
  }

  function navigate(delta){
    if(state.files.length === 0) return;
    let idx = state.currentIndex;
    if(idx < 0) idx = 0;
    idx = (idx + delta + state.files.length) % state.files.length;
    previewImage(idx);
    // scroll thumbnail into view
    const cards = gridEl.querySelectorAll('.file-card');
    if(cards[idx]) cards[idx].scrollIntoView({behavior:'smooth',block:'nearest'});
  }

  function previewImage(index){
    const f = state.files[index];
    if(!f) return;
    state.currentIndex = index;
    previewPanel.removeAttribute('aria-hidden');
    previewTitle.textContent = f.name;
    previewDate.textContent = f.date ? `Date: ${f.date}` : 'Date: unknown';
    viewerEl.innerHTML = '';
    const img = document.createElement('img');
    img.alt = f.name;
    img.src = f.raw;
    img.onload = ()=>{ setZoom(1); };
    img.onerror = ()=>{ viewerEl.innerHTML = '<div class="muted">Failed to load image.</div>'; };
    viewerEl.appendChild(img);
    // update raw button link via click
    document.getElementById('openRaw').onclick = ()=> window.open(f.raw, '_blank');
  }

  function extractDateFromName(name){
    // Try YYYY-MM-DD
    const m = name.match(/(20\d{2}-\d{2}-\d{2})/);
    if(m) return m[1];
    // Try YYYYMMDD
    const m2 = name.match(/(20\d{2})(\d{2})(\d{2})/);
    if(m2) return `${m2[1]}-${m2[2]}-${m2[3]}`;
    return null; // no date found
}

  // small escaping helper
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  // initial load
  try{
    await loadRoot();
  }catch(err){
    console.error(err);
    setStatus('Error: ' + (err.message || err));
  }

})();
</script>
</body>
</html>
